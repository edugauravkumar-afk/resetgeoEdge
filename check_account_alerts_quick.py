#!/usr/bin/env python3
"""
Quick check for alerts on specific account IDs.
Outputs account ID with alert names (or "No alerts" if none).
Uses parallel threading for faster execution.
"""

import os
from datetime import datetime, timedelta
from typing import Dict, List, Any, Set, Tuple
from collections import defaultdict
from concurrent.futures import ThreadPoolExecutor, as_completed
import threading

from dotenv import load_dotenv

from geoedge_projects.client import GeoEdgeClient

# Load environment
load_dotenv()

# Thread-safe lock for collecting results
results_lock = threading.Lock()

# Account IDs to check
ACCOUNT_IDS = [
    "1826290", "1924382", "1217785", "1067821", "1880166", "1910714", "1843612",
    "1741444", "1797664", "1271067", "1914849", "1835084", "1122536", "1768861",
    "1808702", "1774866", "1665676", "1885132", "1903048", "1902977", "1879395",
    "1478359", "1852322", "1840815", "1777029", "1854160", "1899211", "1915469",
    "1916117", "1665684", "1435080", "1923578", "1910087", "1500997", "1432754",
    "1743385", "1595924", "1885232", "1879393", "1308525", "1913293", "1892293",
    "1821987", "1409857", "1882275", "1908843", "1819574", "1448243", "1872546",
    "1891071", "1873730", "1856896", "1833386", "1722127", "1919389", "1861619",
    "1684419", "1899706", "1890112", "1732949", "1547552", "1887100", "1830888",
    "1529651", "1867368", "1868262", "1839287", "1728399", "1925526", "1843665",
    "1823959", "1821718", "1923396", "1920194", "1886588", "1911855", "1890091",
    "1323109", "1837374", "1783075", "1912210", "1910713", "1794632", "1925331",
    "1851796", "1923068", "1901124", "1902715", "1117483", "1889326", "1369901",
    "1894125", "1780742", "1839092", "1867369", "1807410", "1701689", "1850299",
    "1787645", "1891060", "1698897", "1609245", "1495925", "1537795", "1771771",
    "1849574", "1782832", "1609243", "1896450", "1831120", "1891441", "1886165",
    "1683384", "1882041", "1852228", "1609090", "1925686", "1923043", "1895977",
    "1907596", "1149710", "1907588", "1797662", "1352224", "1890113", "1792642",
    "1894772", "1322992", "1884921", "1851775", "1847381", "1473379", "1889995",
    "1882276", "1885974", "1795222", "1878690", "1915447", "1762587", "1652696",
    "1001174", "1915478", "1908609", "1889996", "1840344", "1838590", "1464081",
    "1830791", "1051862", "1919920", "1889972", "1880256", "1655677", "1898580",
    "1505324", "1820130", "1708472", "1698144", "1701239", "1923576", "1798408",
    "1647953", "1906190", "1902761", "1838353", "1567524", "1541417", "1925574",
    "1861681", "1918942", "1861503", "1924730", "1851723", "1832785", "1735987",
    "1895915", "1900125", "1297021", "1815291", "1903660", "1894208", "1666388",
    "1209271", "1462920", "1823954", "1708380", "1573098", "1823958", "1581769",
    "1556878", "1826837", "1901614", "1874050", "1879324", "1237906", "1850601",
    "1798170", "1742424", "1194527", "1894212", "1880930", "1823955", "1923060",
    "1449082", "1334072", "1888089", "1823949", "1487952", "1904024", "1881353",
    "1379439", "1903670", "1605136", "1881443", "1864685", "1638027", "1618242",
    "1522615", "1905228", "1504335", "1192099", "1822421", "1665679", "1439817",
    "1890942", "1632635", "1883184", "1832215", "1774559", "1368919", "1908127",
    "1460645", "1807395", "1639227", "1612360", "1879302", "1560276", "1855543",
    "1902229", "1890354", "1889987", "1732950", "1716393", "1639814", "1919975",
    "1886625", "1290163", "1894029", "1355747", "1117447", "1797634", "1695785",
    "1693510", "1852644", "1641396", "1856109", "1344409", "1820401", "1625891",
    "1662286", "1568716", "1880216", "1522699", "1878456", "1831844", "1551495",
    "1843608", "1837031", "1882257", "1881445", "1510404", "1312816", "1915474",
    "1783517", "1384281", "1720672", "1844594", "1823946", "1902847", "1897538",
    "1787083", "1658066", "1908828", "1888130", "1823935", "1820205", "1922963",
    "1899705", "1849913", "1645997", "1893646", "1777008", "1897710", "1776857",
    "1637614", "1922961", "1871075", "1823948", "1761998", "1746949", "1387055",
    "1835155", "1764949", "1818220", "1764368", "1669242", "1898927", "1897784",
    "1894753", "1677586", "1914267", "1909686", "1479485", "1924091", "1823957",
    "1528092", "1405184", "1882042", "1781382", "1717467", "1696632", "1250914",
    "1076029", "1877917", "1820731", "1504245", "1936846", "1906981", "1894229",
    "1862974", "1704419", "1922795", "1892268", "1828805", "1347365", "1851027",
    "1833465", "1915465", "1901098", "1817022", "1799107", "1775970", "1456720",
    "1892868", "1877932", "1870231", "1823952", "1904368", "1900970", "1794628",
    "1547020", "1921364", "1669377", "1518257", "1938700", "1919308", "1912801",
    "1758095", "1722138", "1663102", "1416889", "1775091", "1537305", "1933776",
    "1871507", "1864399", "1001020", "1903906", "1902796", "1322550", "1910707",
    "1904355", "1847406", "1922790", "1899503", "1891437", "1881831", "1846928",
    "1774560", "1835029", "1611403", "1932401", "1902697", "1897724", "1901873",
    "1838383", "1830564", "1898579", "1890349", "1864206", "1810717", "1750216",
    "1739083", "1712958", "1937146", "1792643", "1734420", "1927275", "1186449",
    "1886879", "1854618", "1846199", "1928096", "1865070", "1668737", "1393559",
    "1902703", "1661490", "1905945", "1885306", "1650667", "1605275", "1192808",
    "1923044", "1918388", "1815113", "1898926", "1890123", "1875262", "1861430",
    "1759944", "1724865", "1904704", "1568917", "1927513", "1921096", "1918914",
    "1883980", "1838613", "1871133", "1912070", "1891433", "1890718", "1909871",
    "1908129", "1850176", "1684803", "1512806", "1343638", "1333622", "1884848",
    "1891074", "1807302", "1701695", "1924087", "1895928", "1883189", "1729546",
    "1496048", "1904363", "1718180", "1603492", "1894804", "1110178", "1928078",
    "1907943", "1850993", "1792646", "1512117", "1927284", "1809381", "1202531",
    "1693687", "1890716", "1872521", "1718983", "1674012", "1199297", "1164233",
    "1920991", "1883181", "1828746", "1807723", "1713773", "1904381", "1860760",
    "1855546", "1818088", "1764449", "1680389", "1924295", "1880065", "1867365",
    "1817949", "1759331", "1688937", "1938857", "1904796", "1898831", "1893902",
    "1850990", "1830748", "1908099", "1885305", "1853576", "1827662", "1921301",
    "1892424", "1889989", "1884536", "1864133", "1822511", "1820724", "1783076",
    "1759153", "1504018", "1456330", "1907657", "1878656", "1821823", "1906175",
    "1896476", "1780949", "1624", "1928136", "1927322", "1914062", "1872524",
    "1811524", "1792645", "1915938", "1897408", "1890115", "1870851", "1615980",
    "1880214", "1889703", "1756414", "1881354", "1285255", "1897535", "1601889",
    "1518619", "1937489", "1902966", "1830567", "1829451", "1821933", "1704425",
    "1026999", "1764364", "1715797", "1456712", "1927835", "1902780", "1899195",
    "1844998", "1817334", "1790656", "1657982", "1602554", "1108436", "1889737",
    "1878655", "1810671", "1899286", "1896031", "1880665", "1846276", "1708672",
    "1846677", "1830816", "1771770", "1733662", "1724861", "1664368", "1473135",
    "1405461", "1929725", "1928076", "1899485", "1842430", "1792687", "1724984",
    "1515464", "1354088", "1924103", "1912844", "1900912", "1814048", "1914307",
    "1892839", "1802875", "1794935", "1905527", "1827130", "1825080", "1731813",
    "1665682", "1901871", "1890752", "1854732", "1775018", "1611941", "1399672",
    "1905231", "1898583", "1885303", "1831453", "1716789", "1902482", "1879304",
    "1874069", "1872525", "1834653", "1708399", "1645102", "1611016", "1488492",
    "1432294", "1887337", "1878764", "1725736", "1890042", "1880650", "1792649",
    "1383428", "1240203", "1896103", "1880290", "1878455", "1537499", "1895772",
    "1828637", "1728043", "1708343", "1456707", "1912826", "1902933", "1889358",
    "1698104", "1611288", "1382003", "1930731", "1927670", "1898540", "1881300",
    "1860972", "1821985", "1805405", "1800380", "1680404", "1592755", "1928109",
    "1908552", "1799821", "1622748", "1921302", "1901629", "1889954", "1867259",
    "1827722", "1656063", "1925110", "1903027", "1880289", "1859356", "1844326",
    "1792641", "1674126", "1632655", "1247351", "1927277", "1907516", "1470244",
    "1456687", "1205860", "1902273", "1900849", "1878741", "1902406", "1429678",
    "1924101", "1857702", "1774415", "1752250", "1688564", "1936002", "1932017",
    "1906171", "1905515", "1898925", "1822541", "1759048", "1749723", "1628095",
    "1522612", "1059119", "1934468", "1914324", "1892365", "1563429", "1919926",
    "1822292", "1799933", "1773398", "1716512", "1603976", "1297535", "1909741",
    "1903942", "1892330", "1722157", "1701690", "1376102", "1921100", "1905524",
    "1843677", "1836530", "1712475", "1680840", "1632372", "1597478", "1437014",
    "1398558", "1395861", "1717710", "1623613", "1369808", "1896719", "1764739",
    "1696847", "1672272", "1624409", "1934078", "1929625", "1927327", "1905318",
    "1886278", "1884930", "1872527", "1713306", "1174206", "1930230", "1803739",
    "1647747", "1489518", "1209685", "1116797", "1896445", "1887806", "1886693",
    "1864433", "1813648", "1798161", "1770855", "1692725", "1522412", "1044718",
    "1804135", "1785819", "1769228", "1738817", "1906143", "1889117", "1778320",
    "1898963", "1881537", "1823943", "1821994", "1723505", "1372840", "1898581",
    "1897537", "1892371", "1891144", "1886701", "1878448", "1846932", "1838382",
    "1522015", "1456703", "1150405", "1921215", "1895800", "1883625", "1852719",
    "1843620", "1720364", "1904373", "1904080", "1903833", "1899707", "1898645",
    "1880469", "1774063", "1647340", "1615883", "1551181", "1521335", "1906064",
    "1898180", "1891308", "1886662", "1876526", "1241610", "1928187", "1923364",
    "1877101", "1823956", "1810271", "1735894", "1430105", "1159448", "1934560",
    "1923812", "1890114", "1821992", "1541269", "1509962", "1915431", "1896656",
    "1828611", "1826894", "1714480", "1172255", "1934552", "1929720", "1915464",
    "1898828", "1711140", "1708689", "1625890", "1899162", "1883066", "1881174",
    "1835080", "1823939", "1817612", "1814256", "1813245", "1798164", "1774172",
    "1510943", "1491556", "1928114", "1921288", "1893702", "1823947", "1791407",
    "1682495", "1616677", "1929681", "1923587", "1886826", "1881299", "1879906",
    "1878377", "1798896", "1682104", "1604889", "1928450", "1928081", "1905292",
    "1892372", "1883581", "1841010", "1837066", "1835485", "1441098", "1324794",
    "1934272", "1924115", "1923857", "1920854", "1917871", "1860684", "1758606",
    "1738829", "1692028", "1598831", "1880260", "1879248", "1868223", "1850045",
    "1703570", "1397317", "1154812", "1928104", "1927226", "1923932", "1923920",
    "1908786", "1907791", "1907517", "1894775", "1894773", "1888006", "1884283",
    "1880292", "1798163", "1786958", "1712116", "1013876", "1929623", "1892280",
    "1887525", "1879249", "1867736", "1789951", "1920685", "1918701", "1908783",
    "1891481", "1813428", "1609074", "1928320", "1920186", "1915251", "1906181",
    "1900307", "1897532", "1889923", "1840042", "1819903", "1241493", "1927325",
    "1905528", "1904372", "1817733", "1765816", "1765082", "1380120", "1332080",
    "1929673", "1923510", "1912530", "1905453", "1903661", "1893508", "1891256",
    "1883650", "1865010", "1718178", "1711849", "1635692", "1610397", "1933760",
    "1925532", "1923104", "1915384", "1905523", "1887434", "1886828", "1856506",
    "1847765", "1809605", "1722128", "1715908", "1674716", "1671278", "1656173",
    "1645100", "1641682", "1597538", "1590065", "1588538", "1502782", "1416404",
    "1272615", "1067118", "1865540", "1815341", "1769586", "1692737", "1539206",
    "1220962", "1103550", "1928080", "1916091", "1905235", "1900852", "1880139",
    "1878706", "1872544", "1750177", "1683056", "1511302", "1933843", "1928174",
    "1922510", "1908111", "1892279", "1889998", "1887730", "1886455", "1884876",
    "1870030", "1860682", "1823941", "1818493", "1749000", "1683145", "1628156",
    "1524183", "1455531", "1920336", "1883869", "1882191", "1881535", "1876367",
    "1823940", "1792639", "1780185", "1777195", "1752258", "1657980", "1655614",
    "1640260", "1504772", "1473160", "1909650", "1909081", "1855673", "1843641",
    "1822245", "1820757", "1784664", "1719771", "1414968", "1923836", "1902986",
    "1879392", "1870703", "1866436", "1860398", "1848721", "1848169", "1814414",
    "1811550", "1786902", "1772903", "1750176", "1749822", "1689947", "1478973",
    "1445738", "1416320", "1924724", "1915477", "1891315", "1887204", "1807414",
    "1775246", "1771870", "1764376", "1748272", "1740406", "1636582", "1610420",
    "1605281", "1503960", "1480689", "1235890", "1014139", "1905525", "1903943",
    "1880291", "1879247", "1818283", "1774465", "1744259", "1701694", "1628931",
    "1160499", "1921030", "1917911", "1907518", "1873746", "1866432", "1719776",
    "1443448", "1231728", "1155463", "1938873", "1937116", "1934069", "1929741",
    "1928181", "1927515", "1923586", "1921016", "1915448", "1910145", "1902964",
    "1889922", "1880903", "1878187", "1844016", "1838276", "1820405", "1757016",
    "1745460", "1712467", "1711850", "1661488", "1628370", "1550727", "1506308",
    "1465622", "1209688", "1148433", "1928178", "1908546", "1901705", "1825441",
    "1819479", "1788011", "1778687", "1712965", "1616525", "1285611", "1937548",
    "1925769", "1918386", "1907979", "1902935", "1892282", "1884166", "1879910",
    "1870902", "1773175", "1769961", "1732199", "1727828", "1715912", "1712948",
    "1662959", "1662065", "1590970", "1573076", "1553771", "1278211", "1929677",
    "1929674", "1922614", "1917919", "1907795", "1903651", "1881528", "1855549",
    "1595663", "1498517", "1938864", "1927124", "1920468", "1898777", "1894720",
    "1891318", "1876581", "1852341", "1795211", "1743061", "1722203", "1668392",
    "1608478", "1563054", "1557606", "1480991", "1403774", "1288041", "1938845",
    "1892286", "1883701", "1872118", "1677900", "1671080", "1507070", "1459851",
    "1349567", "1937782", "1927449", "1899499", "1895972", "1890237", "1878137",
    "1860453", "1853566", "1815294", "1775262", "1775244", "1769887", "1756949",
    "1743527", "1682701", "1289301", "1928896", "1927470", "1925909", "1913139",
    "1902965", "1901060", "1886097", "1799131", "1790000", "1745457", "1743698",
    "1735269", "1670644", "1408282", "1934557", "1933807", "1928975", "1928736",
    "1928166", "1924081", "1923704", "1919556", "1894774", "1892763", "1892165",
    "1890816", "1886094", "1884462", "1881379", "1881371", "1863597", "1842653",
    "1838532", "1770402", "1732287", "1728345", "1712465", "1698545", "1636529",
    "1629268", "1598914", "1496486", "1401086", "1035436", "1885823", "1885665",
    "1883221", "1881295", "1870550", "1846777", "1819019", "1813144", "1804653",
    "1706833", "1648364", "1635782", "1398936", "1928154", "1922589", "1919607",
    "1910643", "1901733", "1896329", "1879383", "1879246", "1878708", "1872516",
    "1842711", "1828584", "1778932", "1768925", "1754640", "1674160", "1431603",
    "1263185", "1938906", "1937717", "1922066", "1895768", "1891537", "1877096",
    "1738845", "1734605", "1730922", "1713323", "1657842", "1642474", "1641395",
    "1561577", "1523008", "1456684", "1403403", "1318843", "1194545", "1132096",
    "1060304", "1919231", "1912809", "1907969", "1900855", "1900559", "1887462",
    "1886666", "1881377", "1881375", "1877297", "1869971", "1852252", "1849900",
    "1781120", "1763613", "1728528", "1722880", "1718181", "1698019", "1626786",
    "1625844", "1625460", "1605279", "1594406", "1551635", "1515818", "1466672",
    "1441724", "1344404", "1219845", "1938854", "1910081", "1909869", "1903944",
    "1902212", "1902211", "1902210", "1895770", "1891536", "1878380", "1847378",
    "1813680", "1674170", "1562510", "1468949", "1455473", "1453741", "1362902",
    "1142217", "1938855", "1934427", "1923240", "1910646", "1907966", "1902213",
    "1899204", "1898406", "1885975", "1883418", "1878703", "1878192", "1822265",
    "1789247", "1781419", "1770261", "1752930", "1718880", "1701258", "1696845",
    "1690420", "1645850", "1639303", "1638847", "1638044", "1629905", "1612431",
    "1602901", "1475358", "1451769", "1413850", "1308810", "1923436", "1901004",
    "1891317", "1882252", "1882251", "1878591", "1870701", "1859687", "1819346",
    "1758732", "1732288", "1690262", "1669762", "1611195", "1540763", "1535571",
    "1379248", "1915480", "1901287", "1901284", "1901161", "1901007", "1886270",
    "1882249", "1849874", "1846934", "1809377", "1799748", "1797958", "1783841",
    "1767620", "1752006", "1728082", "1721505", "1718315", "1700797", "1673183",
    "1652854", "1422719", "1409392", "1364955", "1334065", "1309037", "1240202",
    "1155664", "1132246", "1026550", "1920337", "1901313", "1901006", "1893554",
    "1878379", "1818994", "1814163", "1770019", "1769384", "1692717", "1564252",
    "1504793", "1472573", "1459061", "1420866", "1336593", "1258992", "1936926",
    "1934043", "1933670", "1907450", "1905968", "1905442", "1886709", "1884478",
    "1878491", "1870700", "1856511", "1825088", "1803009", "1797841", "1788642",
    "1778519", "1770472", "1737287", "1731656", "1731654", "1713150", "1711489",
    "1711150", "1658478", "1640264", "1636964", "1629532", "1627958", "1599507",
    "1560648", "1523203", "1500374", "1483859", "1386184", "1335675", "1271376",
    "1036046", "1934116", "1928398", "1928160", "1906054", "1876278", "1818379",
    "1712469", "1608645", "1548790", "1381788", "1309031", "1209622", "1157532",
    "1155663", "1130242"
]


def get_campaign_account_mapping(account_ids: List[str]) -> Dict[str, str]:
    """Get campaign to account mapping from database"""
    import pymysql
    
    host = os.getenv("MYSQL_HOST")
    port = int(os.getenv("MYSQL_PORT", "3306"))
    user = os.getenv("MYSQL_USER")
    password = os.getenv("MYSQL_PASSWORD")
    db = os.getenv("MYSQL_DB")
    
    campaign_to_account = {}
    
    if not all([host, user, password, db]):
        print("âš ï¸ Database credentials not found, skipping campaign-account mapping")
        return campaign_to_account
    
    try:
        connection = pymysql.connect(
            host=host,
            port=port,
            user=user,
            password=password,
            database=db,
            charset="utf8mb4",
            cursorclass=pymysql.cursors.Cursor,
            autocommit=True,
            read_timeout=60,
            write_timeout=60,
        )
        
        print(f"ğŸ“Š Fetching campaigns for {len(account_ids)} accounts from database...")
        
        with connection.cursor() as cursor:
            # Get all campaigns for these accounts
            placeholders = ",".join(["%s"] * len(account_ids))
            sql = f"SELECT id, syndicator_id FROM trc.sp_campaigns WHERE syndicator_id IN ({placeholders})"
            cursor.execute(sql, tuple(account_ids))
            
            for campaign_id, account_id in cursor.fetchall():
                if campaign_id and account_id:
                    campaign_to_account[str(campaign_id)] = str(account_id)
        
        connection.close()
        print(f"âœ… Found {len(campaign_to_account)} campaigns for these accounts")
        
    except Exception as e:
        print(f"âŒ Database error: {e}")
    
    return campaign_to_account


def extract_campaign_id_from_project_name(project_name: str) -> str:
    """Extract campaign ID from project name like '123456789_campaignname'"""
    if not project_name:
        return ""
    parts = project_name.split("_")
    for part in parts:
        stripped = part.strip()
        if stripped.isdigit() and len(stripped) >= 7:
            return stripped
    return ""


def extract_all_numeric_ids_from_project_name(project_name: str) -> List[str]:
    """Extract ALL numeric IDs (6+ digits) from project name to catch both campaign and account IDs"""
    if not project_name:
        return []
    # Split by underscore and get all numeric parts with 6+ digits
    parts = project_name.split("_")
    return [p.strip() for p in parts if p.strip().isdigit() and len(p.strip()) >= 6]


def fetch_alerts_for_chunk(chunk_info: Tuple[int, datetime, datetime], retry_count: int = 3) -> Tuple[int, List[Dict[str, Any]], bool, datetime, datetime]:
    """Fetch alerts for a single time chunk. Returns (chunk_num, alerts, was_capped, start_dt, end_dt)"""
    chunk_num, start_dt, end_dt = chunk_info
    
    for attempt in range(retry_count):
        try:
            client = GeoEdgeClient()
            min_dt = start_dt.strftime("%Y-%m-%d %H:%M:%S")
            max_dt = end_dt.strftime("%Y-%m-%d %H:%M:%S")
            
            alerts = []
            for alert in client.iter_alerts_history(
                min_datetime=min_dt,
                max_datetime=max_dt,
                page_limit=5000,
                max_pages=500  # Increased max pages
            ):
                alerts.append(alert)
            
            was_capped = len(alerts) >= 5000
            return (chunk_num, alerts, was_capped, start_dt, end_dt)
        except Exception as e:
            if attempt < retry_count - 1:
                print(f"  âš ï¸ Chunk {chunk_num} attempt {attempt + 1} failed: {e}, retrying...")
                import time
                time.sleep(2)  # Wait before retry
            else:
                print(f"  âŒ Chunk {chunk_num} failed after {retry_count} attempts: {e}")
                return (chunk_num, [], False, start_dt, end_dt)


def main():
    print(f"ğŸ” Checking alerts for {len(ACCOUNT_IDS)} accounts in the last 90 days...")
    print(f"ğŸ“… Date range: {(datetime.now() - timedelta(days=90)).strftime('%Y-%m-%d')} to {datetime.now().strftime('%Y-%m-%d')}")
    
    # Initialize GeoEdge client (just to verify credentials)
    try:
        client = GeoEdgeClient()
        print("âœ… GeoEdge client initialized")
    except Exception as e:
        print(f"âŒ Failed to initialize GeoEdge client: {e}")
        return
    
    # Get campaign to account mapping
    campaign_to_account = get_campaign_account_mapping(ACCOUNT_IDS)
    
    if not campaign_to_account:
        print("âŒ No campaign mapping found. Cannot proceed.")
        return
    
    # Create reverse mapping: account -> set of campaigns
    account_campaigns: Dict[str, Set[str]] = defaultdict(set)
    for campaign_id, account_id in campaign_to_account.items():
        account_campaigns[account_id].add(campaign_id)
    
    # Calculate date range (last 90 days)
    end_date = datetime.now()
    start_date = end_date - timedelta(days=90)
    
    # Create chunks (1 day each to minimize risk of hitting 5000 limit)
    chunk_days = 1  # Reduced to 1 day for better granularity
    chunks = []
    current_start = start_date
    chunk_num = 0
    
    while current_start < end_date:
        chunk_num += 1
        current_end = min(current_start + timedelta(days=chunk_days), end_date)
        chunks.append((chunk_num, current_start, current_end))
        current_start = current_end
    
    print(f"\nğŸŒ Fetching alerts using {len(chunks)} chunks (1-day each) with parallel threads...")
    
    # Fetch alerts in parallel
    all_alerts = []
    capped_chunks = []
    failed_chunks = []
    completed = 0
    
    # Use 5 parallel threads (to avoid overwhelming the API)
    with ThreadPoolExecutor(max_workers=5) as executor:
        future_to_chunk = {executor.submit(fetch_alerts_for_chunk, chunk): chunk for chunk in chunks}
        
        for future in as_completed(future_to_chunk):
            chunk_num, alerts, was_capped, chunk_start, chunk_end = future.result()
            completed += 1
            
            with results_lock:
                all_alerts.extend(alerts)
                if was_capped:
                    capped_chunks.append((chunk_num, chunk_start, chunk_end))
                if len(alerts) == 0 and not was_capped:
                    # Check if this is a potential failure (0 alerts but not explicitly failed)
                    pass
            
            # Progress indicator every 10 chunks
            if completed % 10 == 0 or completed == len(chunks):
                print(f"  âœ“ Progress: {completed}/{len(chunks)} chunks completed ({len(all_alerts)} alerts so far)")
            
            if was_capped:
                print(f"  âš ï¸ Chunk {chunk_num} CAPPED at 5000 - splitting will be needed")
    
    print(f"\nğŸ“Š Fetched {len(all_alerts)} total alerts from {len(chunks)} chunks")
    
    # Handle capped chunks by re-fetching with smaller windows
    if capped_chunks:
        print(f"\nâš ï¸ {len(capped_chunks)} chunks hit the 5000 limit - splitting into 6-hour windows...")
        
        extra_chunks = []
        for chunk_num, chunk_start, chunk_end in capped_chunks:
            # Split the day into 4 x 6-hour chunks
            current = chunk_start
            sub_num = 0
            while current < chunk_end:
                sub_num += 1
                sub_end = min(current + timedelta(hours=6), chunk_end)
                extra_chunks.append((f"{chunk_num}.{sub_num}", current, sub_end))
                current = sub_end
        
        print(f"   Fetching {len(extra_chunks)} sub-chunks...")
        
        with ThreadPoolExecutor(max_workers=5) as executor:
            future_to_chunk = {executor.submit(fetch_alerts_for_chunk, (i, ec[1], ec[2])): ec for i, ec in enumerate(extra_chunks)}
            
            for future in as_completed(future_to_chunk):
                _, alerts, was_capped, _, _ = future.result()
                with results_lock:
                    all_alerts.extend(alerts)
                    if was_capped:
                        print(f"   âš ï¸ Sub-chunk still capped - some alerts may still be missing")
        
        print(f"   âœ… After sub-chunk fetch: {len(all_alerts)} total alerts")
    
    # Map alerts to accounts
    account_alerts: Dict[str, Set[str]] = defaultdict(set)  # account_id -> set of alert_names
    matched_count = 0
    account_ids_set = set(ACCOUNT_IDS)  # For direct account ID matching
    
    for alert in all_alerts:
        # Get project name and extract campaign ID
        project_name_raw = alert.get("project_name", {})
        if isinstance(project_name_raw, dict) and project_name_raw:
            project_name = list(project_name_raw.values())[0]
        else:
            project_name = str(project_name_raw) if project_name_raw else ""
        
        alert_name = alert.get("alert_name", "Unknown Alert")
        matched = False
        
        # Method 1: Check via campaign ID mapping
        campaign_id = extract_campaign_id_from_project_name(project_name)
        if campaign_id and campaign_id in campaign_to_account:
            account_id = campaign_to_account[campaign_id]
            account_alerts[account_id].add(alert_name)
            matched_count += 1
            matched = True
        
        # Method 2: Check if any account ID appears directly in project name
        if not matched:
            all_ids = extract_all_numeric_ids_from_project_name(project_name)
            for num_id in all_ids:
                if num_id in account_ids_set:
                    account_alerts[num_id].add(alert_name)
                    matched_count += 1
                    matched = True
                    break
    
    print(f"ğŸ”— Matched {matched_count} alerts to {len(account_alerts)} accounts")
    
    # Output results
    print("\n" + "="*80)
    print("RESULTS: Account ID -> Alert Names")
    print("="*80 + "\n")
    
    with_alerts = 0
    without_alerts = 0
    
    # Also save to file
    output_lines = []
    
    for account_id in ACCOUNT_IDS:
        if account_id in account_alerts:
            alert_names = ", ".join(sorted(account_alerts[account_id]))
            line = f"{account_id} -> {alert_names}"
            print(line)
            output_lines.append(line)
            with_alerts += 1
        else:
            line = f"{account_id} -> No alerts"
            print(line)
            output_lines.append(line)
            without_alerts += 1
    
    print("\n" + "="*80)
    print(f"Summary: {with_alerts} accounts with alerts, {without_alerts} accounts without alerts")
    print("="*80)
    
    # Save to file
    output_file = "/Users/gaurav.k/Desktop/geoedge-country-projects/geoPhase3CRT.txt"
    with open(output_file, "w") as f:
        f.write("Account ID -> Alert Names\n")
        f.write("="*80 + "\n\n")
        for line in output_lines:
            f.write(line + "\n")
        f.write("\n" + "="*80 + "\n")
        f.write(f"Summary: {with_alerts} accounts with alerts, {without_alerts} accounts without alerts\n")
    
    print(f"\nğŸ“ Results saved to: {output_file}")


if __name__ == "__main__":
    main()
